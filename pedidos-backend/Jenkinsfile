pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/alejandrazuleta1/k8s', branch: 'main'
            }
        }
        stage('Build Docker Image') {
            steps {
                dir('pedidos-backend') {
                    script {
                        bat 'docker build -t alezuleta/my-tech:latest . || exit /b 1'
                    }
                }
            }
        }
        stage('Test Credentials') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials',
                                                 usernameVariable: 'USER',
                                                 passwordVariable: 'PASS')]) {
                    powershell '''
                        Write-Host "Usuario: $env:USER"
                        docker login -u $env:USER -p $env:PASS
                        docker push alezuleta/my-tech:latest
                    '''
                }
            }
        }
        /*stage('Push to Registry') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials',
                                                 usernameVariable: 'USER',
                                                 passwordVariable: 'PASS')]) {
                     bat 'docker login -u %USER% -p %PASS% || exit /b 1'
                     bat 'docker push alezuleta/my-tech:latest || exit /b 1'
                }
            }
        }*/
    }
}